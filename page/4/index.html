<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, Patty" />





  <link rel="alternate" href="/atom.xml" title="温暖的弦" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.2" />






<meta name="description" content="Life&apos;s like a movie, write your own ending, keep believing, keep pretending.">
<meta property="og:type" content="website">
<meta property="og:title" content="温暖的弦">
<meta property="og:url" content="https://pattyxp.github.io/page/4/index.html">
<meta property="og:site_name" content="温暖的弦">
<meta property="og:description" content="Life&apos;s like a movie, write your own ending, keep believing, keep pretending.">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="温暖的弦">
<meta name="twitter:description" content="Life&apos;s like a movie, write your own ending, keep believing, keep pretending.">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://pattyxp.github.io/page/4/"/>





  <title>温暖的弦</title>
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">温暖的弦</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br />
            
            公益404
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://pattyxp.github.io/2018/01/04/WebViewJavascriptBdidge/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Patty">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/flower.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温暖的弦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/04/WebViewJavascriptBdidge/" itemprop="url">WebViewJavascriptBridge</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-04T13:42:00+08:00">
                2018-01-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这个库主要是作为iOS(mac)和JS之间的桥梁，对于双方来说使用都非常的便利</p>
<p>文件结构非常简单，主要有三部分内容组成</p>
<p>WebViewJavascriptBridge (UIWebView:ios &amp;&amp; WebView:mac)<br>WKWebViewJavascriptBridge（WKWebView:ios）</p>
<p>WebViewJavascriptBridgeBase (实现类)</p>
<p>WebViewJavascriptBridge_js （JS代码注入类）</p>
<p>下面来简单描述下吧<br>WebViewJavascriptBridge 和 WKWebViewJavascriptBridge 两个类主要是针对iOS和mac上使用的，毕竟有所差别，iOS8之后使用WKWebView，所以才有了类WKWebViewJavascriptBridge，但是两个类在接口和声明上，属性，基本都是一致的，这样方便对外公开的接口，内部实现自动判断设备和版本号</p>
<p>下面说明主要针对WebViewJavascriptBridge</p>
<h2 id="WebViewJavascriptBridge-h"><a href="#WebViewJavascriptBridge-h" class="headerlink" title="WebViewJavascriptBridge.h"></a>WebViewJavascriptBridge.h</h2><ul>
<li><p>宏定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#if (__MAC_OS_X_VERSION_MAX_ALLOWED &gt; __MAC_10_9 || __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= __IPHONE_7_1)</span><br><span class="line">#define supportsWKWebView</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
</li>
<li><p>引入库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#if defined supportsWKWebView</span><br><span class="line">#import &lt;WebKit/WebKit.h&gt;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
</li>
<li><p>宏定义 根据设备类型，引入对应的库，<br>定义 WVJB_WEBVIEW_TYPE、WVJB_WEBVIEW_DELEGATE_TYPE、WVJB_WEBVIEW_DELEGATE_INTERFACE</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#if defined __MAC_OS_X_VERSION_MAX_ALLOWED</span><br><span class="line">    #define WVJB_PLATFORM_OSX</span><br><span class="line">    #define WVJB_WEBVIEW_TYPE WebView</span><br><span class="line">    #define WVJB_WEBVIEW_DELEGATE_TYPE NSObject&lt;WebViewJavascriptBridgeBaseDelegate&gt;</span><br><span class="line">    #define WVJB_WEBVIEW_DELEGATE_INTERFACE NSObject&lt;WebViewJavascriptBridgeBaseDelegate, WebPolicyDelegate&gt;</span><br><span class="line">#elif defined __IPHONE_OS_VERSION_MAX_ALLOWED</span><br><span class="line">    #import &lt;UIKit/UIWebView.h&gt;</span><br><span class="line">    #define WVJB_PLATFORM_IOS</span><br><span class="line">    #define WVJB_WEBVIEW_TYPE UIWebView</span><br><span class="line">    #define WVJB_WEBVIEW_DELEGATE_TYPE NSObject&lt;UIWebViewDelegate&gt;</span><br><span class="line">    #define WVJB_WEBVIEW_DELEGATE_INTERFACE NSObject&lt;UIWebViewDelegate, WebViewJavascriptBridgeBaseDelegate&gt;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
</li>
<li><p>对外公开实现方法</p>
</li>
</ul>
<h2 id="WebViewJavascriptBridge-m"><a href="#WebViewJavascriptBridge-m" class="headerlink" title="WebViewJavascriptBridge.m"></a>WebViewJavascriptBridge.m</h2><ul>
<li><p>如果支持WKWebView，引入对应的类，这样直接外部引入这个类就可以实现相应功能了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#if defined(supportsWKWebView)</span><br><span class="line">#import &quot;WKWebViewJavascriptBridge.h&quot;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
</li>
<li><p>宏定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#if __has_feature(objc_arc_weak)</span><br><span class="line">    #define WVJB_WEAK __weak</span><br><span class="line">#else</span><br><span class="line">    #define WVJB_WEAK __unsafe_unretained</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
</li>
<li><p>内部属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@implementation WebViewJavascriptBridge &#123;</span><br><span class="line">    WVJB_WEAK WVJB_WEBVIEW_TYPE* _webView; //webview</span><br><span class="line">    WVJB_WEAK id _webViewDelegate;  //delegate</span><br><span class="line">    long _uniqueId;  //实测是在发送消息的时候，将消息体和responseBlock等数据一起存在字典里，字典里对应存放的key是uniqueId,value是responseBlock，对应一个webView类来说，此数不断加1 ，用以区分不同的message</span><br><span class="line">    WebViewJavascriptBridgeBase *_base; //具体实现的功能类</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>两个类方法用于打印日志Log,最大长度500</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ (void)enableLogging &#123;</span><br><span class="line">    [WebViewJavascriptBridgeBase enableLogging];</span><br><span class="line">&#125;</span><br><span class="line">+ (void)setLogMaxLength:(int)length &#123;</span><br><span class="line">    [WebViewJavascriptBridgeBase setLogMaxLength:length];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>初始化<br>可以看出，针对判断不同的类型生成对应的webViewBridge，如果不是已申明的对应webView类型，就报异常</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+ (instancetype)bridgeForWebView:(id)webView &#123;</span><br><span class="line">    return [self bridge:webView];</span><br><span class="line">&#125;</span><br><span class="line">+ (instancetype)bridge:(id)webView &#123;</span><br><span class="line">#if defined supportsWKWebView</span><br><span class="line">    if ([webView isKindOfClass:[WKWebView class]]) &#123;</span><br><span class="line">        return (WebViewJavascriptBridge*) [WKWebViewJavascriptBridge bridgeForWebView:webView];</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    if ([webView isKindOfClass:[WVJB_WEBVIEW_TYPE class]]) &#123;</span><br><span class="line">        WebViewJavascriptBridge* bridge = [[self alloc] init];</span><br><span class="line">        [bridge _platformSpecificSetup:webView];</span><br><span class="line">        return bridge;</span><br><span class="line">    &#125;</span><br><span class="line">    [NSException raise:@&quot;BadWebViewType&quot; format:@&quot;Unknown web view type.&quot;];</span><br><span class="line">    return nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>可以看出，由该类封装的方法内部还是让base去做相对应的事情</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (void)send:(id)data &#123;</span><br><span class="line">    [self send:data responseCallback:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)send:(id)data responseCallback:(WVJBResponseCallback)responseCallback &#123;</span><br><span class="line">    [_base sendData:data responseCallback:responseCallback handlerName:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)callHandler:(NSString *)handlerName &#123;</span><br><span class="line">    [self callHandler:handlerName data:nil responseCallback:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)callHandler:(NSString *)handlerName data:(id)data &#123;</span><br><span class="line">    [self callHandler:handlerName data:data responseCallback:nil];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)callHandler:(NSString *)handlerName data:(id)data responseCallback:(WVJBResponseCallback)responseCallback &#123;</span><br><span class="line">    [_base sendData:data responseCallback:responseCallback handlerName:handlerName];</span><br><span class="line">&#125;</span><br><span class="line">- (void)registerHandler:(NSString *)handlerName handler:(WVJBHandler)handler &#123;</span><br><span class="line">    _base.messageHandlers[handlerName] = [handler copy];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)removeHandler:(NSString *)handlerName &#123;</span><br><span class="line">    [_base.messageHandlers removeObjectForKey:handlerName];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)disableJavscriptAlertBoxSafetyTimeout &#123;</span><br><span class="line">    [_base disableJavscriptAlertBoxSafetyTimeout];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>剩下的就是针对 OSX 以及 iOS 分别做的初始化操作和实现对应的方法了，目的是一样的，实现上稍有差异</p>
</li>
</ul>
<p>这里有一个属性_webViewDelegate，是由外部调用接口实现赋值的，如果有需要在请求开始，结束，失败的时候做特殊处理，可以调用该方法实现对应的代理方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (void)setWebViewDelegate:(WVJB_WEBVIEW_DELEGATE_TYPE*)webViewDelegate &#123;</span><br><span class="line">    _webViewDelegate = webViewDelegate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="WebViewJavascriptBridgeBase"><a href="#WebViewJavascriptBridgeBase" class="headerlink" title="WebViewJavascriptBridgeBase"></a>WebViewJavascriptBridgeBase</h2><ul>
<li><p>sendData方法，上面已经提到了，具体实现看下 核心差不多就是这些了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">- (void)sendData:(id)data responseCallback:(WVJBResponseCallback)responseCallback handlerName:(NSString*)handlerName &#123;</span><br><span class="line">    NSMutableDictionary* message = [NSMutableDictionary dictionary];</span><br><span class="line"></span><br><span class="line">    if (data) &#123;</span><br><span class="line">        message[@&quot;data&quot;] = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (responseCallback) &#123;</span><br><span class="line">        NSString* callbackId = [NSString stringWithFormat:@&quot;objc_cb_%ld&quot;, ++_uniqueId];</span><br><span class="line">        self.responseCallbacks[callbackId] = [responseCallback copy];</span><br><span class="line">        message[@&quot;callbackId&quot;] = callbackId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (handlerName) &#123;</span><br><span class="line">        message[@&quot;handlerName&quot;] = handlerName;</span><br><span class="line">    &#125;</span><br><span class="line">    [self _queueMessage:message];//这里将数据组装在字典里，然后发送</span><br><span class="line">&#125;</span><br><span class="line">- (void)_queueMessage:(WVJBMessage*)message &#123;</span><br><span class="line">    if (self.startupMessageQueue) &#123;</span><br><span class="line">        [self.startupMessageQueue addObject:message];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        [self _dispatchMessage:message]; //消息执行</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)_dispatchMessage:(WVJBMessage*)message &#123;</span><br><span class="line">    NSString *messageJSON = [self _serializeMessage:message pretty:NO];</span><br><span class="line">    [self _log:@&quot;SEND&quot; json:messageJSON];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\\&quot; withString:@&quot;\\\\&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\&quot;&quot; withString:@&quot;\\\&quot;&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\&apos;&quot; withString:@&quot;\\\&apos;&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\n&quot; withString:@&quot;\\n&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\r&quot; withString:@&quot;\\r&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\f&quot; withString:@&quot;\\f&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\u2028&quot; withString:@&quot;\\u2028&quot;];</span><br><span class="line">    messageJSON = [messageJSON stringByReplacingOccurrencesOfString:@&quot;\u2029&quot; withString:@&quot;\\u2029&quot;];</span><br><span class="line"></span><br><span class="line">    //以上是将消息字典转为JSON对象，然后字符转义</span><br><span class="line">    NSString* javascriptCommand = [NSString stringWithFormat:@&quot;WebViewJavascriptBridge._handleMessageFromObjC(&apos;%@&apos;);&quot;, messageJSON];//执行JS方法</span><br><span class="line">    if ([[NSThread currentThread] isMainThread]) &#123;</span><br><span class="line">        [self _evaluateJavascript:javascriptCommand];//主线程执行</span><br><span class="line"></span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        dispatch_sync(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">            [self _evaluateJavascript:javascriptCommand];</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>剩下的方法，主要就是在发送消息时候的数据类型校验之类的，由WebViewJavascriptBridge和WKWebViewJavascriptBridge调用<br>如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType &#123;</span><br><span class="line">    if (webView != _webView) &#123; return YES; &#125; //校验</span><br><span class="line"></span><br><span class="line">    NSURL *url = [request URL];</span><br><span class="line">    __strong WVJB_WEBVIEW_DELEGATE_TYPE* strongDelegate = _webViewDelegate;</span><br><span class="line">    if ([_base isWebViewJavascriptBridgeURL:url]) &#123; //校验URL</span><br><span class="line">        if ([_base isBridgeLoadedURL:url]) &#123; //校验URL</span><br><span class="line">            [_base injectJavascriptFile]; //注入JS</span><br><span class="line">        &#125; else if ([_base isQueueMessageURL:url]) &#123; //校验URL</span><br><span class="line">            NSString *messageQueueString = [self _evaluateJavascript:[_base webViewJavascriptFetchQueyCommand]];</span><br><span class="line">            [_base flushMessageQueue:messageQueueString]; //执行消息队列</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            [_base logUnkownMessage:url];</span><br><span class="line">        &#125;</span><br><span class="line">        return NO;</span><br><span class="line">    &#125; else if (strongDelegate &amp;&amp; [strongDelegate respondsToSelector:@selector(webView:shouldStartLoadWithRequest:navigationType:)]) &#123; //如果有代理，拦截并执行代理方法</span><br><span class="line">        return [strongDelegate webView:webView shouldStartLoadWithRequest:request navigationType:navigationType];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="native-和-JS-如何交互"><a href="#native-和-JS-如何交互" class="headerlink" title="native 和 JS 如何交互"></a>native 和 JS 如何交互</h2><p>具体其实看下官方demo走一遍流程就明了了</p>
<p>JS调用native,如何响应</p>
<p>首先，JS实现如下方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">function setupWebViewJavascriptBridge(callback) &#123;</span><br><span class="line">    ...</span><br><span class="line">    var WVJBIframe = document.createElement(&apos;iframe&apos;);</span><br><span class="line">    WVJBIframe.style.display = &apos;none&apos;; //设置不显示</span><br><span class="line">    WVJBIframe.src = &apos;https://__bridge_loaded__&apos;;</span><br><span class="line">    document.documentElement.appendChild(WVJBIframe);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line">JS 端调用 setupWebViewJavascriptBridge，注入了一个页面，不显示的，scr和base里面的定义kBridgeLoaded一致，所以判断时候满足isBridgeLoadedURL，就会调用注入JS的方法了</span><br></pre></td></tr></table></figure></p>
<p>JS 端调用 bridge.callHandler 时，调用 iOS handler，参数校验之后调用_doSend 函数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function callHandler(handlerName, data, responseCallback) &#123;</span><br><span class="line">  if (arguments.length == 2 &amp;&amp; typeof data == &apos;function&apos;) &#123; //校验</span><br><span class="line">    responseCallback = data;</span><br><span class="line">    data = null;</span><br><span class="line">  &#125;</span><br><span class="line">  _doSend(&#123; handlerName:handlerName, data:data &#125;, responseCallback);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function _doSend(message, responseCallback) &#123;</span><br><span class="line">  if (responseCallback) &#123;</span><br><span class="line">    var callbackId = &apos;cb_&apos;+(uniqueId++)+&apos;_&apos;+new Date().getTime();</span><br><span class="line">    responseCallbacks[callbackId] = responseCallback;</span><br><span class="line">    message[&apos;callbackId&apos;] = callbackId;</span><br><span class="line">  &#125;</span><br><span class="line">  sendMessageQueue.push(message);</span><br><span class="line">  messagingIframe.src = CUSTOM_PROTOCOL_SCHEME + &apos;://&apos; + QUEUE_HAS_MESSAGE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>可以看到 JS 端的代码中有 callHandler 函数的实现，其内部将入参 handlerName,data,responseCallback 以字典形式作为参数调用_doSend 方法，我们看一下_doSend 方法的实现:</p>
</blockquote>
<ul>
<li>doSend 方法内部会先判断入参中是否有回调</li>
<li>如果有回调则根据规则生成 callbackId 并且将回调 block 保存到 responseCallbacks字典，之后给消息也加入一个键值对保存刚才生成的 callbackId</li>
<li>给 sendMessageQueue 队列加入 message</li>
<li>messagingIframe.src 设置为 <a href="https://__wvjb_queue_message__" target="_blank" rel="noopener">https://__wvjb_queue_message__</a><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">messagingIframe = document.createElement(&apos;iframe&apos;);</span><br><span class="line">messagingIframe.style.display = &apos;none&apos;;</span><br><span class="line">messagingIframe.src = CUSTOM_PROTOCOL_SCHEME + &apos;://&apos; + QUEUE_HAS_MESSAGE;</span><br><span class="line">document.documentElement.appendChild(messagingIframe);</span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>这里加入了一个 src 为 <a href="https://__wvjb_queue_message__" target="_blank" rel="noopener">https://__wvjb_queue_message__</a> 的 messagingIframe，它也是一个不可见的 iframe。这样 Native 端会收到一个 url 为 <a href="https://__wvjb_queue_message__" target="_blank" rel="noopener">https://__wvjb_queue_message__</a> 的 request，之后会进行各项判定，这次会满足[isQueueMessageURL：url]调用 Native 的MessageQueue 方法</p>
</blockquote>
<p>然后调用native端的核心方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">if ([_base isQueueMessageURL:url]) &#123;</span><br><span class="line">     NSString *messageQueueString = [self _evaluateJavascript:[_base webViewJavascriptFetchQueyCommand]];</span><br><span class="line">     //执行JS的fetchQueue方法，将JS的所有消息数组转为json然后清空数组</span><br><span class="line"></span><br><span class="line">     [_base flushMessageQueue:messageQueueString];//核心</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)flushMessageQueue:(NSString *)messageQueueString&#123;</span><br><span class="line">    ...</span><br><span class="line">    //将拿到的消息，解析</span><br><span class="line">    id messages = [self _deserializeMessageJSON:messageQueueString];</span><br><span class="line">    for (WVJBMessage* message in messages) &#123;</span><br><span class="line">        if (![message isKindOfClass:[WVJBMessage class]]) &#123;</span><br><span class="line">            NSLog(@&quot;WebViewJavascriptBridge: WARNING: Invalid %@ received: %@&quot;, [message class], message);</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line">        [self _log:@&quot;RCVD&quot; json:message];</span><br><span class="line"></span><br><span class="line">        NSString* responseId = message[@&quot;responseId&quot;];</span><br><span class="line">        if (responseId) &#123;</span><br><span class="line">            WVJBResponseCallback responseCallback = _responseCallbacks[responseId];</span><br><span class="line">            responseCallback(message[@&quot;responseData&quot;]); //执行对应的responseBlock</span><br><span class="line">            [self.responseCallbacks removeObjectForKey:responseId];</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            WVJBResponseCallback responseCallback = NULL;</span><br><span class="line">            NSString* callbackId = message[@&quot;callbackId&quot;];</span><br><span class="line">            if (callbackId) &#123;</span><br><span class="line">                responseCallback = ^(id responseData) &#123;</span><br><span class="line">                    if (responseData == nil) &#123;</span><br><span class="line">                        responseData = [NSNull null];</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    WVJBMessage* msg = @&#123; @&quot;responseId&quot;:callbackId, @&quot;responseData&quot;:responseData &#125;;</span><br><span class="line">                    [self _queueMessage:msg];</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                responseCallback = ^(id ignoreResponseData) &#123;</span><br><span class="line">                    // Do nothing</span><br><span class="line">                &#125;;</span><br><span class="line">            &#125;</span><br><span class="line">            //生成responseBlock</span><br><span class="line">            WVJBHandler handler = self.messageHandlers[message[@&quot;handlerName&quot;]];</span><br><span class="line"></span><br><span class="line">            if (!handler) &#123;</span><br><span class="line">                NSLog(@&quot;WVJBNoHandlerException, No handler for message from JS: %@&quot;, message);</span><br><span class="line">                continue;</span><br><span class="line">            &#125;</span><br><span class="line">            //处理方法</span><br><span class="line">            handler(message[@&quot;data&quot;], responseCallback);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>WebViewJavascriptBridge 的工作流：</p>
<ul>
<li>JS 端加入 src 为 <a href="https://__bridge_loaded__" target="_blank" rel="noopener">https://__bridge_loaded__</a> 的 iframe</li>
<li>Native 端检测到 Request，检测如果是 <strong>bridge_loaded</strong> 则通过当前的 WebView 组件注入 WebViewJavascriptBridge_JS 代码</li>
<li>注入代码成功之后会加入一个 messagingIframe，其 src 为 <a href="https://__wvjb_queue_message__" target="_blank" rel="noopener">https://__wvjb_queue_message__</a></li>
<li>之后不论是 Native 端还是 JS 端都可以通过 registerHandler 方法注册一个两端约定好的 HandlerName 的处理，也都可以通过 callHandler 方法通过约定好的 HandlerName 调用另一端的处理（两端处理消息的实现逻辑对称）</li>
</ul>
<h2 id="阅读文献"><a href="#阅读文献" class="headerlink" title="阅读文献"></a>阅读文献</h2><p>WebViewJavascriptBridge 源码中 Get 到的“桥梁美学”  <a href="http://www.10tiao.com/html/216/201712/2652556802/1.html" target="_blank" rel="noopener">http://www.10tiao.com/html/216/201712/2652556802/1.html</a></p>

          
        
      
    </div>
    
    
    

    


    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://pattyxp.github.io/2018/01/04/2018Flag/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Patty">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/flower.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温暖的弦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/04/2018Flag/" itemprop="url">2018Flag</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-04T11:37:32+08:00">
                2018-01-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今年初，创建下此博客，希望能够记录下自己的成长，工作之后感觉越来越懒了，需要监督自己了。<br>去年的时候记得也没有做什么特别的大事，只是出了趟国旅游，拿到了驾照，本来打算买车了，后面也没想法了。。。</p>
<p>生活Flag:<br>提高英语听说能力，坚持背单词，看美剧提高吧 ~ ~ ~<br>今年想要去趟成都旅游 ~ ~ ~</p>
<p>工作Flag:<br>多看点源码，学点新技术</p>
<p>今年就此在学习和生活上，都有个新的期待和变化吧</p>

          
        
      
    </div>
    
    
    

    


    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://pattyxp.github.io/2018/01/04/YYImage解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Patty">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/flower.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温暖的弦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/04/YYImage解析/" itemprop="url">YYImage解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-04T11:00:02+08:00">
                2018-01-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>文件结构图如下:</p>
<p><img src="/images/YYImage文件结构.png" alt="YYImage文件结构"></p>
<h2 id="解析前api阅读实现思路"><a href="#解析前api阅读实现思路" class="headerlink" title="解析前api阅读实现思路:"></a>解析前api阅读实现思路:</h2><p>视图层<br>YYImage ：用于生成单张图片，可以根据图片的名称或者路径或者data实例化，接口和UIIImage相似<br>YYFrameImage: 用于记录一组图片，可以传入图片的数组、时间间隔数组，循环的次数，默认显示首图并初始化参数<br>YYSpriteSheetImage: 传入单张大图片，以及一组图片的每帧显示内容区域、图片显示的时间、循环的次数</p>
<p>显示层<br>YYAnimatedImageView</p>
<p>图片解码层<br>YYImageCoder</p>
<p>图片生成相对简单，对于多帧处理，以前很少接触，内存缓存和显示（编码解码方面）也都陌生些，<br>其实是有UIImageView来显示图片，动图可能含有多图或者多帧，所以需要动画来轮播，根据每张图片需要显示的动画时间来设置<br>阅读源码感受，实现比较优化，使用的预加载内存的方式提高效率，设置缓冲区，设置显示图片，如果没有就加入队列请求，开始重绘，播放动画。</p>
<p>##源码解读：</p>
<p>###YYImage</p>
<p><strong>支持的图片类型</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">typedef NS_ENUM(NSUInteger, YYImageType) &#123;</span><br><span class="line">    YYImageTypeUnknown = 0, ///&lt; unknown</span><br><span class="line">    YYImageTypeJPEG,        ///&lt; jpeg, jpg</span><br><span class="line">    YYImageTypeJPEG2000,    ///&lt; jp2</span><br><span class="line">    YYImageTypeTIFF,        ///&lt; tiff, tif</span><br><span class="line">    YYImageTypeBMP,         ///&lt; bmp</span><br><span class="line">    YYImageTypeICO,         ///&lt; ico</span><br><span class="line">    YYImageTypeICNS,        ///&lt; icns</span><br><span class="line">    YYImageTypeGIF,         ///&lt; gif</span><br><span class="line">    YYImageTypePNG,         ///&lt; png</span><br><span class="line">    YYImageTypeWebP,        ///&lt; webp</span><br><span class="line">    YYImageTypeOther,       ///&lt; other image format</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="YYFrameImage"><a href="#YYFrameImage" class="headerlink" title="YYFrameImage"></a>YYFrameImage</h3><p>专门用来显示基于帧的动画图像类<br>仅支持系统图片格式例如 png 和 jpeg<br>YYFrameImage 可以把静态图片类型如 png 和 jpeg 格式的静态图像用帧切换的方式以动态图片的形式显示，并且提供了 4 个常用的初始化方法方便我们使用。如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (nullable instancetype)initWithImagePaths:(NSArray&lt;NSString *&gt; *)paths</span><br><span class="line">                           oneFrameDuration:(NSTimeInterval)oneFrameDuration</span><br><span class="line">                                  loopCount:(NSUInteger)loopCount;</span><br><span class="line">- (nullable instancetype)initWithImagePaths:(NSArray&lt;NSString *&gt; *)paths</span><br><span class="line">                             frameDurations:(NSArray&lt;NSNumber *&gt; *)frameDurations</span><br><span class="line">                                  loopCount:(NSUInteger)loopCount;</span><br><span class="line">- (nullable instancetype)initWithImageDataArray:(NSArray&lt;NSData *&gt; *)dataArray</span><br><span class="line">                               oneFrameDuration:(NSTimeInterval)oneFrameDuration</span><br><span class="line">                                      loopCount:(NSUInteger)loopCount;</span><br><span class="line">- (nullable instancetype)initWithImageDataArray:(NSArray&lt;NSData *&gt; *)dataArray</span><br><span class="line">                                 frameDurations:(NSArray *)frameDurations</span><br><span class="line">                                      loopCount:(NSUInteger)loopCount;</span><br></pre></td></tr></table></figure></p>
<p>疑问code</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (UIImage *)animatedImageFrameAtIndex:(NSUInteger)index &#123;</span><br><span class="line">    if (_imagePaths) &#123;</span><br><span class="line">        ...</span><br><span class="line">        return [[UIImage imageWithData:data scale:scale] imageByDecoded];</span><br><span class="line">        //Q:为什么需要实现imageByDecoded</span><br><span class="line">        //A:解码 否则只是先加载进入内存</span><br><span class="line">       ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (instancetype)imageByDecoded &#123;</span><br><span class="line">    if (self.isDecodedForDisplay) return self;//第一次decodecopy之后，下一次就不需要进行了</span><br><span class="line"></span><br><span class="line">    CGImageRef imageRef = self.CGImage;</span><br><span class="line">    if (!imageRef) return self;</span><br><span class="line"></span><br><span class="line">    CGImageRef newImageRef = YYCGImageCreateDecodedCopy(imageRef, YES);</span><br><span class="line">    if (!newImageRef) return self;</span><br><span class="line"></span><br><span class="line">    UIImage *newImage = [[self.class alloc] initWithCGImage:newImageRef scale:self.scale orientation:self.imageOrientation];</span><br><span class="line">    CGImageRelease(newImageRef);</span><br><span class="line">    if (!newImage) newImage = self; // decode failed, return self.</span><br><span class="line">    newImage.isDecodedForDisplay = YES;</span><br><span class="line">    return newImage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>###YYSpriteSheetImage<br>提供一个初始化方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (nullable instancetype)initWithSpriteSheetImage:(UIImage *)image</span><br><span class="line">                                     contentRects:(NSArray&lt;NSValue *&gt; *)contentRects</span><br><span class="line">                                   frameDurations:(NSArray&lt;NSNumber *&gt; *)frameDurations</span><br><span class="line">                                        loopCount:(NSUInteger)loopCount;</span><br><span class="line"></span><br><span class="line">一个实例方法</span><br><span class="line">- (CGRect)contentsRectForCALayerAtIndex:(NSUInteger)index;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (CGRect)contentsRectForCALayerAtIndex:(NSUInteger)index &#123;</span><br><span class="line">    CGRect layerRect = CGRectMake(0, 0, 1, 1);</span><br><span class="line">    if (index &gt;= _contentRects.count) return layerRect; //校验入参索引</span><br><span class="line"></span><br><span class="line">    CGSize imageSize = self.size;</span><br><span class="line">    CGRect rect = [self animatedImageContentsRectAtIndex:index];//找到对应索引的真实位置 RealRect</span><br><span class="line">    if (imageSize.width &gt; 0.01 &amp;&amp; imageSize.height &gt; 0.01) &#123;</span><br><span class="line">        layerRect.origin.x = rect.origin.x / imageSize.width;</span><br><span class="line">        layerRect.origin.y = rect.origin.y / imageSize.height;</span><br><span class="line">        layerRect.size.width = rect.size.width / imageSize.width;</span><br><span class="line">        layerRect.size.height = rect.size.height / imageSize.height;//得到指定索引帧的逻辑定位 LogicRect</span><br><span class="line">        layerRect = CGRectIntersection(layerRect, CGRectMake(0, 0, 1, 1));//确保逻辑定位没有超出画布的部分</span><br><span class="line">        if (CGRectIsNull(layerRect) || CGRectIsEmpty(layerRect)) &#123;</span><br><span class="line">            layerRect = CGRectMake(0, 0, 1, 1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return layerRect;//将处理后的逻辑定位 LogicRect 作为图层定位 LayerRect 返回</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">根据索引找到对应帧的 CALayer 位置，该接口返回一个由 0.0~1.0 之间的数值组成的图层定位 LayerRect</span><br></pre></td></tr></table></figure>
<p>###YYAnimatedImageView</p>
<h4 id="图片更改4步骤"><a href="#图片更改4步骤" class="headerlink" title="图片更改4步骤:"></a>图片更改4步骤:</h4><p>改变图片<br>重置动画<br>初始化动画参数<br>重绘</p>
<h4 id="YYAnimatedImageView"><a href="#YYAnimatedImageView" class="headerlink" title="YYAnimatedImageView"></a>YYAnimatedImageView</h4><p>使图片动起来是依靠 CADisplayLink</p>
<p>变量切换帧图像，其内部的实现逻辑可以简单理解为：<br>根据当前帧索引推出下一帧索引<br>使用下一帧索引去帧缓冲区尝试获取对应帧图像<br>如果找到对应帧图像则使用渲染绘制功能<br>如果没找到则根据条件向图片请求队列加入请求操作</p>
<h4 id="值得一提的实现细节"><a href="#值得一提的实现细节" class="headerlink" title="值得一提的实现细节"></a>值得一提的实现细节</h4><p>YYAnimatedImageView 实现<br>&gt;<br>对帧缓冲区_buffer 的操作都使用_lock 上锁<br>通过将图片请求队列_requestQueue 的 maxConcurrentOperationCount 设置为 1 使图片请求队列成为串行队列（最大并发数为 1）<br>图片请求队列中加入的操作均为_YYAnimatedImageViewFetchOperation<br>为了避免使用 CADisplayLink 可能造成的循环引用设计了_YYImageWeakProxy</p>
<p>YYAnimatedImageViewFetchOperation</p>
<p>####这里简单描述一下 main 函数内部实现逻辑：<br>&gt;<br>判断帧缓冲区大小<br>扫描下一帧以及当前允许缓冲范围内之后的帧图片<br>如果发现丢失的帧则尝试重新获取帧图像并加入到帧缓冲<br>操作中对于 view 缓冲区的操作也都上了锁<br>操作由于是放入图片请求队列中进行的，内部有对 isCancelled 做判断，如果操作已经被取消（发生在更改图片、停止动画、手动更改当前帧、收到内存警告或 App 进入后台等）则需要及时跳出<br>对于新的线程优先级只在 main 方法范围内有效，所以推荐把操作的实现放在 main 中而非 start（如需覆盖 start 方法时，需要关注 isExecuting 和 isFinished 两个 key paths）</p>
<h2 id="疑问code"><a href="#疑问code" class="headerlink" title="疑问code"></a>疑问code</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> LOCK(</span><br><span class="line">         if (_buffer.count) &#123;</span><br><span class="line">             NSMutableDictionary *holder = _buffer;</span><br><span class="line">             _buffer = [NSMutableDictionary new];</span><br><span class="line">             dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_LOW, 0), ^&#123;</span><br><span class="line">                 // Capture the dictionary to global queue,</span><br><span class="line">                 // release these images in background to avoid blocking UI thread.</span><br><span class="line">                 [holder class];</span><br><span class="line">             &#125;);</span><br><span class="line">         &#125;</span><br><span class="line">    );</span><br><span class="line">Q:怎么做到的  [holder class]怎么就能够release these images</span><br><span class="line">A: 每个异步线程，其实内部都有一个对应的autoreleasePool，当执行 [holder class]，这个holder类就被放进了当前的线程池，当方法结束，线程池就将改对象进行释放，因此buffer里的数据也就慢慢清掉了，缓存的图片数据就不占用内存空间了</span><br></pre></td></tr></table></figure>
<p>##扩展 NSOperation</p>
<ul>
<li><p>执行主任务</p>
<blockquote>
<p>从最低限度上来说，每一个 operation 都应该至少实现以下两个方法：<br>1.一个自定义的初始化方法；<br>2.main 方法。</p>
</blockquote>
</li>
<li><p>响应取消事件</p>
</li>
</ul>
<blockquote>
<p>当一个 operation 开始执行后，它会一直执行它的任务直到完成或被取消为止。我们可以在任意时间点取消一个 operation ，甚至是在它还未开始执行之前。为了让我们自定义的 operation 能够支持取消事件，我们需要在代码中定期地检查 isCancelled 方法的返回值，一旦检查到这个方法返回 YES ，我们就需要立即停止执行接下来的任务。根据苹果官方的说法，isCancelled 方法本身是足够轻量的，所以就算是频繁地调用它也不会给系统带来太大的负担。<br>The isCancelled method itself is very lightweight and can be called frequently without any significant performance penalty.<br>通常来说，当我们自定义一个 operation 类时，我们需要考虑在以下几个关键点检查 isCancelled 方法的返回值：<br>在真正开始执行任务之前；<br>至少在每次循环中检查一次，而如果一次循环的时间本身就比较长的话，则需要检查得更加频繁；<br>在任何相对来说比较容易中止 operation 的地方。<br>看到这里，我想你应该可以意识到一点，那就是尽管 operation 是支持取消操作的，但却并不是立即取消的，而是在你调用了 operation 的 cancel 方法之后的下一个 isCancelled 的检查点取消的。</p>
</blockquote>
<h2 id="YYImageCoder-源码解析"><a href="#YYImageCoder-源码解析" class="headerlink" title="YYImageCoder  源码解析"></a>YYImageCoder  源码解析</h2><p>主要就是对于图片的解压缩，解压缩到位图才能够正常的渲染，但是图片的解压缩一般都在显示的时候才会去做而且是在主线程，非常耗CPU，所以需要提前在子线程先进行解压缩操作是非常必要的</p>
<p>这里主要就是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CG_EXTERN CGContextRef __nullable CGBitmapContextCreate(void * __nullable data,</span><br><span class="line">    size_t width, size_t height, size_t bitsPerComponent, size_t bytesPerRow,</span><br><span class="line">    CGColorSpaceRef cg_nullable space, uint32_t bitmapInfo)</span><br><span class="line">    CG_AVAILABLE_STARTING(__MAC_10_0, __IPHONE_2_0);</span><br></pre></td></tr></table></figure></p>
<ul>
<li>data ：如果不为 NULL ，那么它应该指向一块大小至少为 bytesPerRow * height 字节的内存；如果 为 NULL ，那么系统就会为我们自动分配和释放所需的内存，所以一般指定 NULL 即可；</li>
<li>width 和 height ：位图的宽度和高度，分别赋值为图片的像素宽度和像素高度即可；</li>
<li>bitsPerComponent ：像素的每个颜色分量使用的 bit 数，在 RGB 颜色空间下指定 8 即可；</li>
<li>bytesPerRow ：位图的每一行使用的字节数，大小至少为 width * bytes per pixel 字节。有意思的是，当我们指定 0 时，系统不仅会为我们自动计算，而且还会进行 cache line alignment 的优化，更多信息可以查看 what is byte alignment (cache line alignment) for Core Animation? Why it matters? 和 Why is my image’s Bytes per Row more than its Bytes per Pixel times its Width? ，亲测可用；</li>
<li>space ：就是我们前面提到的颜色空间，一般使用 RGB 即可；</li>
<li>bitmapInfo ：就是我们前面提到的位图的布局信息。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>图片动图的切换绘制，使用递归锁，信号量,线程和缓冲区提高效率<br>支持的图片类型非常丰富<br>编码解码看着很复杂，绘图</p>
<p>代码封装性好，接口很简单，实现很逻辑</p>
<h2 id="阅读链接"><a href="#阅读链接" class="headerlink" title="阅读链接"></a>阅读链接</h2><p><a href="http://www.jianshu.com/p/9601a4b8d01c" target="_blank" rel="noopener">http://www.jianshu.com/p/9601a4b8d01c</a></p>
<p><a href="http://www.leichunfeng.com/" target="_blank" rel="noopener">http://www.leichunfeng.com/</a></p>
<p>YYImagecoder源码解析:<a href="http://www.jianshu.com/p/b1750084c7a5" target="_blank" rel="noopener">http://www.jianshu.com/p/b1750084c7a5</a>  </p>

          
        
      
    </div>
    
    
    

    


    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://pattyxp.github.io/2018/01/04/MJRefresh解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Patty">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/flower.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温暖的弦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/04/MJRefresh解析/" itemprop="url">MJRefresh解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-04T10:53:46+08:00">
                2018-01-04
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="解析前阅读api"><a href="#解析前阅读api" class="headerlink" title="解析前阅读api"></a>解析前阅读api</h2><p>MJRefreshComponent.h</p>
<p>1.MJRefreshState 有5个状态，如果我设计，只会想到4个， willRefresh和 pulling状态会认为是一致的<br>2.刚开始看的时候，觉得监听只需要contentOffset和pan手势就够了</p>
<p>解析前总结：<br>设计一个UIView，把刷新控件都初始化好，然后状态就根据拖动刷新的状态去更新就好了。<br>依据拖动的手势和位移，修改父类scrollView的contentSize，显示刷新控件和隐藏控件，调用刷新的方法和回调方法即可。</p>
<h2 id="疑问code"><a href="#疑问code" class="headerlink" title="疑问code"></a>疑问code</h2><p>beginRefreshing方法里，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (self.window) &#123;</span><br><span class="line">    self.state = MJRefreshStateRefreshing;</span><br><span class="line">&#125; else &#123;</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>有时候window为null，原因是view没有完全加载完成或者在ViewDidload中才刚刚加载完,view的window属性无法被获取<br>正确应该使用UIApplication.keywindow</p>
<h2 id="文件结构功能图-Github上已有-http-t-cn-RYHwK6n"><a href="#文件结构功能图-Github上已有-http-t-cn-RYHwK6n" class="headerlink" title="文件结构功能图 Github上已有(http://t.cn/RYHwK6n)"></a>文件结构功能图 Github上已有(<a href="http://t.cn/RYHwK6n" target="_blank" rel="noopener">http://t.cn/RYHwK6n</a>)</h2><p><strong>MJRefreshComponent</strong> 这个类作为该控件的基类，涵盖了基类所具备的一些：状态，回调block，子类继承的方法等</p>
<p>##Header<br><strong>MJRefreshHeader</strong>    MJRefreshHeader继承于MJRefreshComponent，它做了这几件事：初始化方法，初始化y和高度，状态切换等</p>
<p>疑问点:<br>一开始不明白基类MJRefreshComponent为什么申明的状态有五个<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/** 刷新控件的状态 */</span><br><span class="line">typedef NS_ENUM(NSInteger, MJRefreshState) &#123;</span><br><span class="line">    /** 普通闲置状态 */</span><br><span class="line">    MJRefreshStateIdle = 1,</span><br><span class="line">    /** 松开就可以进行刷新的状态 */</span><br><span class="line">    MJRefreshStatePulling,</span><br><span class="line">    /** 正在刷新中的状态 */</span><br><span class="line">    MJRefreshStateRefreshing,</span><br><span class="line">    /** 即将刷新的状态 */</span><br><span class="line">    MJRefreshStateWillRefresh,</span><br><span class="line">    /** 所有数据加载完毕，没有更多的数据了 */</span><br><span class="line">    MJRefreshStateNoMoreData</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>以为MJRefreshStatePulling是多余的，我设计的话应该只会有4个，<br>现在明白了，header刷新的时候，状态切换的因素有两个：一个是下拉的距离是否超过临界值，另一个是 手指是否离开屏幕。<br>即使在下拉的距离超过了临界距离（状态栏 + 导航栏 + header高度），如果手指没有离开屏幕，那么也不能马上进行刷新，而是将状态切换为：可以刷新。<br>一旦手指离开了屏幕，马上将状态切换为正在刷新。</p>
<p><strong>MJRefreshStateHeader</strong> 带有状态文字的刷新控件<br>stateLabel 和 lastUpdatedTimeLabel ，根据状态的切换变化内容，显示时间的label还可以依据用户自定义的日期格式显示，<br>lastUpdatedTimeLabel可以隐藏</p>
<p><strong>MJRefreshNormalHeader</strong> 带有_arrowView和loadingView<br>根据刷新的state来隐藏和显示这两个视图</p>
<p><strong>MJRefreshGifHeader</strong> 左侧是一个gif动画<br>可以根据不同状态配置不同的照片和动画时间</p>
<p>##Footer</p>
<p><strong>MJRefreshFooter:</strong><br>与header相比，只是多了设置MJRefreshStateNoMoreData状态</p>
<p>提供以下几个功能:<br>初始化视图<br>没有数据时候重设对应状态<br>没有数据时候对应的操作<br>是否支持自动隐藏视图，如果支持，将替换系统的reloadData方法为自定义的方法，内部实现是多执行一句mj_reloadDataBlock回调</p>
<p>在视图添加或者移除的时候，设置setMj_reloadDataBlock方法，之前奇怪为什么header的时候没有，这个功能是为了刷新数据结束的时候根据当前的cell个数（tableview或collectionview的数据源为空）来判断是否需要隐藏footerView</p>
<p><strong>MJRefreshBackFooter</strong> 需要上拉才会触发刷新动作<br>当状态结束，恢复初始状态 （？？？ 回弹体现什么）<br><strong>MJRefreshAutoFooter</strong> 自动上拉加载类。滑动到底部触发刷新动作，无需上拉操作。<br>triggerAutomaticallyRefreshPercent 底部控件出现多少就开始自动刷新<br>automaticallyRefresh 是否自动刷新，默认YES</p>
<p><strong>MJRefreshBackStateFooter</strong> 提供label ，可以设置不同状态下的标签内容<br><strong>MJRefreshBackNormalFooter</strong> 提供箭头和loading圆圈，根据状态显示和隐藏<br><strong>MJRefreshBackGifFooter</strong> 提供设置gif动画的一组图片</p>
<p><strong>MJRefreshAutoStateFooter</strong> 相比较MJRefreshBackStateFooter，给stateLabel添加了手势，当点击的时候如果当前是默认状态就执行刷新<br><strong>MJRefreshAutoNormalFooter</strong> 提供箭头和loading圆圈，根据状态显示和隐藏<br><strong>MJRefreshAutoGifFooter</strong> 提供设置gif动画的一组图片</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>MJRefreshHeader: 负责header的高度和调整header自身在外部的位置。<br>MJRefreshStateHeader:负责header内部的stateLabel和lastUpdatedTimeLabel的布局和不同状态下内部文字的显示。<br>MJRefreshNormalHeader:负责header内部的loadingView以及arrowView的布局和不同状态下的显示。<br>MJRefreshGifHeader:负责header内部的Gif动画的布局和不同状态下的显示。</p>
<p>MJRefreshFooter: 负责footer高度和监听scrollView数据的变化<br>MJRefreshBackFooter:跟Header的封装思路是一样的<br>MJRefreshAutoFooter:类似于MJRefreshHeader类的功能</p>
<p>以下设计思路和对应的header一致<br>MJRefreshBackStateFooter：封装思路类似于MJRefreshStateHeader<br>MJRefreshBackNormalFooter：封装思路类似于MJRefreshNormalHeader<br>MJRefreshBackGifFooter：封装思路类似于MJRefreshGifHeader<br>MJRefreshAutoStateFooter：封装思路类似于MJRefreshStateHeader<br>MJRefreshAutoNormalFooter：封装思路类似于MJRefreshNormalHeader<br>MJRefreshAutoGifFooter：封装思路类似于MJRefreshGifHeader</p>
<p>通过一个基类来定义一些状态和一些需要子类实现的接口。通过一层一层地继承，让每一层的子类各司其职，只完成真正属于自己的任务，提高了框架的可定制性，而且对于功能的扩展和bug的追踪也很有帮助，非常值得我们参考与借鉴。</p>
<p>##优秀code</p>
<p>1.很多地方设置控件的frame的时候，都是通过先判断其约束的个数如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if (self.lastUpdatedTimeLabel.constraints.count == 0) &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>然后再设置约束，就比较仔细</p>
<p>2.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MJRefreshCheckState 状态检查，通过宏来与之前状态比较，一样就return</span><br></pre></td></tr></table></figure></p>
<p>3.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">willMoveToSuperview方法，在里面判断移除之前的观察者</span><br></pre></td></tr></table></figure></p>
<p>4.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">- (CGFloat)mj_textWith &#123;</span><br><span class="line">    CGFloat stringWidth = 0;</span><br><span class="line">    CGSize size = CGSizeMake(MAXFLOAT, MAXFLOAT);</span><br><span class="line">    if (self.text.length &gt; 0) &#123;</span><br><span class="line">#if defined(__IPHONE_OS_VERSION_MAX_ALLOWED) &amp;&amp; __IPHONE_OS_VERSION_MAX_ALLOWED &gt;= 70000</span><br><span class="line">        stringWidth =[self.text</span><br><span class="line">                      boundingRectWithSize:size</span><br><span class="line">                      options:NSStringDrawingUsesLineFragmentOrigin</span><br><span class="line">                      attributes:@&#123;NSFontAttributeName:self.font&#125;</span><br><span class="line">                      context:nil].size.width;</span><br><span class="line">#else</span><br><span class="line"></span><br><span class="line">        stringWidth = [self.text sizeWithFont:self.font</span><br><span class="line">                             constrainedToSize:size</span><br><span class="line">                                 lineBreakMode:NSLineBreakByCharWrapping].width;</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line">    return stringWidth;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>5.多语言设置</p>
<h2 id="阅读资料："><a href="#阅读资料：" class="headerlink" title="阅读资料："></a>阅读资料：</h2><p><a href="http://www.jianshu.com/p/89ca6437c5e9" target="_blank" rel="noopener">http://www.jianshu.com/p/89ca6437c5e9</a></p>

          
        
      
    </div>
    
    
    

    


    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://pattyxp.github.io/2018/01/02/博客搭建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Patty">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/flower.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="温暖的弦">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/01/02/博客搭建/" itemprop="url">博客搭建</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-01-02T17:43:15+08:00">
                2018-01-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h3><p>之前一直有在收集一些大神的博客，自己也肖想了一把建立自己的博客地址，于是乎就有了个开端</p>
<p>在此之前，我也是小白一枚啊，遇到了一些非常浅显的坑，但是一直没有发现导致纠结了一下，整个整下来大概花了2小时吧 ~ ~ ~</p>
<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><p>首先安装些必备的环境是分分钟的事情啦，网上有相关教程的，如有问题请自行google</p>
<ul>
<li>Node.js</li>
<li><p>Git (Xcode自带，可以绕行)</p>
</li>
<li><p>当Node.js和Git都安装好后就可以正式安装Hexo了，终端执行如下命令：<br>$ sudo npm install -g hexo</p>
</li>
<li><p>初始化</p>
</li>
</ul>
<p>本地自己建立存放的文件夹，cd到当前文件目录下，执行以下命令<br>$ hexo init xxx (xxx 是你建立的文件夹名称。cd到xxx文件夹下，执行如下命令，安装npm：)<br>$ npm install<br>执行如下命令，开启hexo服务器:<br>$ hexo s<br>此时，浏览器中打开网址<a href="http://localhost:4000，" target="_blank" rel="noopener">http://localhost:4000，</a><br>能看到helloWorld的页面，此时本地显示已经OK<br>效果如图:<br><img src="/images/初建博客.png" alt="效果如图"></p>
<ul>
<li>管理github<br>建立自己的github账号之后，将mac下的ssh内容上传到setting里相应的位置<br>选择新建一个responsity，注意，命名非常重要，我就是在这里被卡了一小时的感觉<br>比如我的Github名称是pattyXP,但是建立的仓库名称，需要符合规则: github名称.github.io ，我一开始写错了，写成了patty.github.io，为此哀伤一下下 ~ ~ ~<br>然后，进入到该仓库的主页下，选择setting，滑到GitHub Pages一级，将source选择为master，点击save，这是为什么呢？（因为之前在本地文件下有一个.yml，打开后往下滑到最后，修改成下边的样子：<br>deploy:<br>  type: git<br>  repository: <a href="https://github.com/pattyXP/pattyXP.github.io.git" target="_blank" rel="noopener">https://github.com/pattyXP/pattyXP.github.io.git</a><br> branch: master）<br>然后打开自己的<a href="https://pattyxp.github.io/">https://pattyxp.github.io/</a><br>效果就和本地的localhost:4000一模一样了(😅)</li>
</ul>
<h2 id="后面的维护"><a href="#后面的维护" class="headerlink" title="后面的维护"></a>后面的维护</h2><p>hexo支持markdown语法，所以本地的文章可以使用markdown语法来编写，之后保存为xx.md即可，放在博客的文件夹下的source/_posts/xx.md即可<br>最后，执行如下命令就可以上传成功了<br>hexo new xxx<br>hexo g （生成静态页面）<br>hexo d  (将文章部署到Github)</p>
<h2 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h2><p>可能还需要用到的命令<br>hexo clean<br>hexo d -g</p>
<h2 id="参考教程"><a href="#参考教程" class="headerlink" title="参考教程"></a>参考教程</h2><p>博客搭建教程: <a href="http://jeasonstudio.github.io" target="_blank" rel="noopener">http://jeasonstudio.github.io</a><br>博客主题搭建: <a href="http://theme-next.iissnan.com/getting-started.html" target="_blank" rel="noopener">http://theme-next.iissnan.com/getting-started.html</a><br>博客主题定制化: <a href="http://shenzekun.cn/" target="_blank" rel="noopener">http://shenzekun.cn/</a></p>

          
        
      
    </div>
    
    
    

    


    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/flower.jpg"
               alt="Patty" />
          <p class="site-author-name" itemprop="name">Patty</p>
           
              <p class="site-description motion-element" itemprop="description">Life's like a movie, write your own ending, keep believing, keep pretending.</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">35</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              <a href="/tags/index.html">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Patty</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

<div class="powered-by">
<i class="fa fa-user-md"></i>
<span id="busuanzi_container_site_uv">
  本站总访问量<span id="busuanzi_value_site_uv"></span>次
</span>
<span class="post-count"> 博客全站共59.3k字</span>
</div>



        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.2"></script>



  
    <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.2"></script>

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.2"></script>



  


  




	





  





  






  





  

  

  

  

  

  

  <!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/love.js"></script>

</body>
</html>
